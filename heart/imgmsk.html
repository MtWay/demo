<!DOCTYPE html>
<html>
<meta name="viewport"
	content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

<head>
	<meta charset="UTF-8">
	<title>heart</title>
	<style type="text/css">
	.lit {
				width: 20px;
				height: 20px;
				border-radius: 50%;
				position: absolute;
				background: url(../canvas/img/heart1.png) no-repeat;
				background-size: 100%;
			}
			
			.lit0 {
				animation: name 1s linear;
			}
			
			.lit1 {
				animation: name1 1s linear;
			}
			
			.lit2 {
				animation: name2 1s linear;
			}
			
			.lit3 {
				animation: name3 1s linear;
			}
			
			.lit4 {
				animation: name4 1s linear;
			}
			
			.lit5 {
				animation: name5 1s linear;
			}
			
			.lit6 {
				animation: name6 1s linear;
			}
			
			.lit7 {
				animation: name7 1s linear;
			}
			
			@keyframes name {
				from {
					transform: translate(0, 0);
				}
				to {
					transform: translate(100px, 100px);
					width: 0;
					height: 0;
				}
			}
			
			@keyframes name1 {
				from {
					transform: translate(0, 0);
				}
				to {
					transform: translate(0px, 100px);
					width: 0;
					height: 0;
				}
			}
			
			@keyframes name2 {
				from {
					transform: translate(0, 0);
				}
				to {
					transform: translate(100px, 0px);
					width: 0;
					height: 0;
				}
			}
			
			@keyframes name3 {
				from {
					transform: translate(0, 0);
				}
				to {
					transform: translate(-100px, 100px);
					width: 0;
					height: 0;
				}
			}
			
			@keyframes name4 {
				from {
					transform: translate(0, 0);
				}
				to {
					transform: translate(100px, -100px);
					width: 0;
					height: 0;
				}
			}
			
			@keyframes name5 {
				from {
					transform: translate(0, 0);
				}
				to {
					transform: translate(-100px, -100px);
					width: 0;
					height: 0;
				}
			}
			
			@keyframes name6 {
				from {
					transform: translate(0, 0);
				}
				to {
					transform: translate(-100px, 0px);
					width: 0;
					height: 0;
				}
			}
			
			@keyframes name7 {
				from {
					transform: translate(0, 0);
				}
				to {
					transform: translate(0px, -100px);
					width: 0;
					height: 0;
				}
			}
		body {
			margin: 0;
			padding: 0;
			overflow: hidden;
			height: 100%;
			width: 100vw;
		}

		/* div {
			display: none;
		} */

		.box {
			margin: 20px auto;
			display: block !important;
		}

		input {
			width: 100px;
			margin-right: 10px;
		}

		canvas {
			width: 100vw;
			height: 100vh;
			margin: 0 auto;
			display: block;
			/* border: 1px solid #f00; */
		}

		.hide {
			display: none;
		}
		p{
			font-family: fangsong;
    font-weight: bold;
    font-size: 20px;
	text-align: center
		}

		/*canvas{background: #0f0 ;}*/
	</style>
	<!-- <script src="js/jquery-2.1.0.js" type="text/javascript" charset="utf-8"></script> -->
	<script src="https://www.17sucai.com/preview/1085771/2018-08-01/timetable/script/zepto.min.js"
		type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		$(function () {
			let kl = 8;
			var IMG = new Image();

			// })
			//				var ctx =  $("#can")[0].getContext('2d');
			canvas = document.getElementById("can");
			context = canvas.getContext('2d');

			dcan = document.getElementById("dcan");
			dcontext = dcan.getContext('2d');

			var ans = [];
			var ox = canvas.offsetLeft;
			var oy = canvas.offsetTop;
			//				console.log(oy)
			$(document).on("touchmove", function (e) {
				e.preventDefault();
				e.stopPropagation()
				// console.log(e);
					var l = e.touches[0].clientX-25,
						t = e.touches[0].clientY - 25,
				$div = document.createElement("div"),
						r = Math.floor(Math.random() * 8),
						R2 = Math.floor(Math.random() * 6);
						// color = ["#f00", "#00f", "#0f0", "#ff0", "#0ff", "#ccc"];
					$($div).css({ left: l, top: t }).addClass("lit" + r).addClass("lit");
					//        if(index%3==0)s
					$("body").append($div);
					setTimeout(function() {
						$($div).remove();
					}, 500)
				// console.log(e);
				// $("canvas").mousemove(function(e){

				// canvas.onmousemove=function(e){
				//					console.log(e.clientX);
				var x = e.touches[0].clientX - ox;
				var y = e.touches[0].clientY - oy;
				var len = ans.length;
				// console.log(len)
				// if (len > 5000) {
				// 	showimg('img/a.jpg', 1);
				// 	return
				// }
				for (var i = 0; i < len; i++) {
					if(ans[i].radius<kl){
						continue
					}
					//判断鼠标移入某个圆（其实是矩形）；
					if (x > ans[i].x - ans[i].radius && x < ans[i].x + ans[i].radius && y > ans[i].y - ans[i]
						.radius && y < ans[i].y + ans[i].radius) {
						var a1 = getImageData({
							x: ans[i].x - ans[i].radius / 2,
							y: ans[i].y - ans[i].radius / 2,
							radius: ans[i].radius / 2,
							w: 1,
							h: 1
						});
						var a2 = getImageData({
							x: ans[i].x + ans[i].radius / 2,
							y: ans[i].y - ans[i].radius / 2,
							radius: ans[i].radius / 2,
							w: 1,
							h: 1
						});
						var a3 = getImageData({
							x: ans[i].x - ans[i].radius / 2,
							y: ans[i].y + ans[i].radius / 2,
							radius: ans[i].radius / 2,
							w: 1,
							h: 1
						});
						var a4 = getImageData({
							x: ans[i].x + ans[i].radius / 2,
							y: ans[i].y + ans[i].radius / 2,
							radius: ans[i].radius / 2,
							w: 1,
							h: 1
						});
						ans.splice(i, 1); //删除大圆		
						ans.push(a1);
						ans.push(a2);
						ans.push(a3);
						ans.push(a4);
						// console.log(ans);
						// $("#can").attr({
						// 	width: w,
						// 	height: h
						// });
						// drawmsk(ans)

						drawmsk([a1,a2,a3,a4])
					}

				}

				// }
			})

			//				show('123456')
			//				showimg('img/f28f240cb4f8156ba242bfd1feb7dc30.jpg');
			showimg('../assess/b.jpg');
			var ww = $('body').width();
			var wh = $('body').height();

			function showimg(src, flag) {
				resize();
				ans = [];
				let img =IMG
				img.src = src;
				//				img.width=800;
				img.onload = function () {
					var sw = img.width / ww;
					var sh = img.height / wh;
					var s = sw > sh ? sh : sw;

					var w = img.width / s;
					var h = img.height / s;
					var x = -(w - ww) / 2;
					var y = -(h - wh) / 2;
					dcontext.fillStyle = "#fff";
dcontext.rect(0, 0, ww, wh);
					dcontext.fill();
					dcontext.drawImage(img, x, y, w, h);
					context.drawImage(img, x, y, w, h);
					//				var ndata = dcan.toDataURL(0.9);
					//				$("img").attr("src",ndata)
					//				var arr = getImageData();
					// if (flag) {
					// context.drawImage(img, x, y, w, h);
					// 	return
					// }
					
					var a = getImageData({
						x: ww / 2,
						y: wh / 2,
						dx:20,
						dy:20,
						w: 1,
						h: 1
					});
					// console.log(a)
					a.radius = wh;
					ans.push(a)
					//				var arr = getImageData();
					drawmsk(ans);
				}
			}

			function Dot(centerX, centerY, centerZ, radius, color) {
				this.dx = centerX; //保存原来的位置
				this.dy = centerY;
				this.dz = centerZ;
				this.tx = 0; //保存粒子聚合后又飞散开的位置
				this.ty = 0;
				this.tz = 0;
				this.z = centerZ;
				this.x = centerX;
				this.y = centerY;
				this.radius = radius;
				this.r = color.r;
				this.g = color.g;
				this.b = color.b;
			}

			function getImageData(option) {
				var defaults = {
					x: 0,
					y: 0,
					w: w,
					h: h,
					radius: 1
				};

				var opt ={...defaults,...option}
				//  $.extend(defaults, option);
				if(opt.x<0)opt.x=0;
				if(opt.y<0)opt.y=0;
				if(opt.x>ww-1)opt.x=ww-1;
				if(opt.y>wh-1)opt.y=wh-1;
				opt.x+=opt.dx ||0;
				opt.y+=opt.dy||0;
				var imageData = dcontext.getImageData(opt.x, opt.y, opt.w, opt.h);
				//					console.log(imageData);
				var place = 0,
					places = [];
				for (var x = 0; x < imageData.width; x++) {
					for (var y = 0; y < imageData.height; y++) {
						//var i = 4*(x * imageData.height + y);
						var i = 4 * (y * imageData.width + x);
						if (imageData.data[i + 3] > 128 || place == 0) {
							
							var r = imageData.data[i],
								g = imageData.data[i + 1],
								b = imageData.data[i + 2];
							//									console.log(r)
							place++;
							(place % 4 == 0) && places.push(new Dot(x, y, 0, 2, {
								r: r,
								g: g,
								b: b
							}));
							(place == 1) && places.push(new Dot(opt.x, opt.y, 0, opt.radius, {
								r: r,
								g: g,
								b: b
							}));

						}
					}
				}
				if (places.length == 1) {
					places = places[0]
				}
				return places;
			}

			function drawmsk(arr) {
				//					resize()
				let length = arr.length;
				let index = 0,
					drr = [];
					let img = IMG;
					// let ww = $('body').width();
					// var sw = img.width / ww;
					// var sh = img.height / ww;
					// var s = sw > sh ? sw : sh;

					// var w = img.width / s;
					// var h = img.height / s;
					// var x = -(w - ww) / 2;
					// var y = -(h - ww) / 2;
					// context.drawImage(img, x, y, w, h);

				for (let i = 0; i < length; i++) {
					if(arr[i].radius>kl){
					// context.beginPath()
					// context.rect(arr[i].x-arr[i].radius, arr[i].y-arr[i].radius, arr[i].radius*2,arr[i].radius*2 );
					// context.fillStyle = "rgba(" + arr[i].r + "," + arr[i].g + "," + arr[i].b + ",0.1)";
					// context.fill();
context.beginPath()
					context.arc(arr[i].x, arr[i].y, arr[i].radius, 0, Math.PI * 2, true);
					context.fillStyle = "rgb(" + arr[i].r + "," + arr[i].g + "," + arr[i].b + ")";
					context.fill();
					}else{
						
						var imageData = dcontext.getImageData(arr[i].x-arr[i].radius, arr[i].y-arr[i].radius, arr[i].radius*2+1, arr[i].radius*2+1);
						context.putImageData(imageData,arr[i].x-arr[i].radius, arr[i].y-arr[i].radius)
					}	
					
					//					context.stroke();	
					//						}

				}
			}

			function draw(arr) {
				resize()
				let length = arr.length;
				let index = 0,
					drr = [];
					// console.log(img, x, y, w, h)

				for (let i = 0; i < length; i++) {
					var mark = 1;
					//					let l = ((arr[i].x-arr[index].x)*(arr[i].x-arr[index].x))+((arr[i].y-arr[index].y)*(arr[i].y-arr[index].y));

					index++;

					context.beginPath()
					var x = Math.floor(arr[i].x / (arr[i].radius * 2)) * arr[i].radius * 2;
					var y = Math.floor(arr[i].y / (arr[i].radius * 2)) * arr[i].radius * 2;
					arr[i].x = x;
					arr[i].y = y;
					for (let j = 0; j < drr.length; j++) {
						if (drr[j].x == x && drr[j].y == y) {
							mark = 0;
							break;
						}
					}
					drr.push(arr[i])
					if (mark) {
						context.arc(x, y, arr[i].radius, 0, Math.PI * 2, true);
						context.fillStyle = "rgb(" + arr[i].r + "," + arr[i].g + "," + arr[i].b + ")";
						context.fill();
						//					context.stroke();	
					}

				}
				// console.log(index);
			}

			//调整画布尺寸
			function resize() {
				w = $("canvas").width();
				h = $("canvas").height();
				$("canvas").attr({
					width: w,
					height: h
				});
			}
	

			//圖片預覽地址
			function handleFiles(obj) {
				var files = obj.files,
					img = new Image();
				//File API
				//          alert(files[0].name + "," + files[0].size + " bytes");
				img.src = window.URL.createObjectURL(files[0]); //创建一个object URL，并不是你的本地路径
				img.onload = function (e) {
					window.URL.revokeObjectURL(this.src); //图片加载后，释放object URL
				}
				return img.src;
			}

		})
	</script>
</head>

<body>
	<canvas id="can" width="" height=""></canvas>
	<canvas id="dcan" width="" height="" class="hide"></canvas>
	<div class="box">
		<!--<input type="text" name="txt" id="txt" value="" /><button>变</button>-->
		<!-- <input type="file" name="file" id="file" value="" placeholder="选择一张图片" /> -->
		<!-- <img src="" /> -->
		<p>试着划下上边看看</p>
	</div>
</body>

</html>